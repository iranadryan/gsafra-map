import './assets/styles/global.css';
import { CoordinatesType } from './types/talhao';
import convertStringCoordinatesToArray from './utils/convertStringCoordinatesToArray';
import getAreasCenter from './utils/getAreasCenter';
import getCityCoordinates from './utils/getCityCoordinates';
import getZoomLevel from './utils/getZoomLevel';

const mapElement = document.getElementById('map');

let map: google.maps.Map;
let infoWindow: google.maps.InfoWindow;
let geocoder: google.maps.Geocoder;

interface talhao {
  id: number;
  nome: string;
  area: number;
  coordenadas: string;
}

const queryParams = new URLSearchParams(window.location.search);
const idTalhao = Number(queryParams.get('idTalhao'));
const cidade = queryParams.get('cidade');
const uf = queryParams.get('uf');

// const talhoes: talhao[] = [
//   {
//     id: 1,
//     nome: 'TALHAO 1',
//     area: 100,
//     coordenadas:
//       '-47.293984,-3.54028 -47.291495,-3.541325 -47.289195,-3.542337 -47.287066,-3.543228 -47.284371,-3.544411 -47.282689,-3.545011 -47.282156,-3.545285 -47.281865,-3.545388 -47.279702,-3.540742 -47.280062,-3.541034 -47.280354,-3.54112 -47.280663,-3.541257 -47.280886,-3.54136 -47.281247,-3.54124 -47.28147,-3.541034 -47.281762,-3.54076 -47.281882,-3.540434 -47.282019,-3.540382 -47.282242,-3.540331 -47.282551,-3.539902 -47.282843,-3.539611 -47.283186,-3.53932 -47.283427,-3.539062 -47.283787,-3.538805 -47.284079,-3.538754 -47.284337,-3.538857 -47.284577,-3.538891 -47.284886,-3.538891 -47.285126,-3.538891 -47.285371,-3.538903 -47.28556,-3.53892 -47.285766,-3.538989 -47.285989,-3.539212 -47.286109,-3.539383 -47.286349,-3.53964 -47.286572,-3.539777 -47.286693,-3.539863 -47.28695,-3.539983 -47.287259,-3.540052 -47.287551,-3.540017 -47.287637,-3.539863 -47.287688,-3.539657 -47.28774,-3.539486 -47.287877,-3.53928 -47.288135,-3.539229 -47.288495,-3.539229 -47.288598,-3.539229 -47.288804,-3.539263 -47.28901,-3.539263 -47.289027,-3.539143 -47.289079,-3.538817 -47.289062,-3.53856 -47.289147,-3.53832 -47.289147,-3.538063 -47.289113,-3.537772 -47.289044,-3.537669 -47.288821,-3.537617 -47.288478,-3.537497 -47.288306,-3.537377 -47.288272,-3.53712 -47.288272,-3.53688 -47.288255,-3.536572 -47.288581,-3.536297 -47.288924,-3.536229 -47.289182,-3.536246 -47.289353,-3.536332 -47.289628,-3.536332 -47.289834,-3.536229 -47.290006,-3.536143 -47.290177,-3.536143 -47.290349,-3.536246 -47.290521,-3.536417 -47.290589,-3.536537 -47.290624,-3.536572 -47.290812,-3.536632 -47.29095,-3.536512 -47.291156,-3.536478 -47.29143,-3.536547 -47.291619,-3.536427 -47.291602,-3.536135 -47.291585,-3.535878 -47.291602,-3.535689 -47.291602,-3.535484 -47.291791,-3.535209 -47.291877,-3.535072 -47.291945,-3.534901 -47.292048,-3.534781 -47.292186,-3.534729 -47.292323,-3.534695 -47.292512,-3.534609 -47.292701,-3.534575 -47.292872,-3.534506 -47.293113,-3.535655 -47.293336,-3.536804 -47.293353,-3.537524 -47.293696,-3.538535 -47.293817,-3.538912 -47.29392,-3.539341 -47.294023,-3.539718 -47.294211,-3.540164 -47.293984,-3.54028',
//   },
//   {
//     id: 2,
//     nome: 'TALHAO 3',
//     area: 200,
//     coordenadas:
//       '-47.277968,-3.537494 -47.278105,-3.537734 -47.278105,-3.537991 -47.27814,-3.538111 -47.27826,-3.538248 -47.278483,-3.538265 -47.278655,-3.538436 -47.278758,-3.53871 -47.278809,-3.53919 -47.278843,-3.539447 -47.278998,-3.53967 -47.279084,-3.539858 -47.279221,-3.54015 -47.27941,-3.540338 -47.279564,-3.540629 -47.279702,-3.540783 -47.27977,-3.541006 -47.279942,-3.54128 -47.280303,-3.541966 -47.280457,-3.542325 -47.280697,-3.542891 -47.281075,-3.543662 -47.281418,-3.544364 -47.281659,-3.544776 -47.281865,-3.545324 -47.281607,-3.545495 -47.280835,-3.545752 -47.280337,-3.545958 -47.279788,-3.546215 -47.278689,-3.546677 -47.277796,-3.547054 -47.277007,-3.547414 -47.276062,-3.547757 -47.275015,-3.548219 -47.274003,-3.548613 -47.272835,-3.54911 -47.272011,-3.549401 -47.271239,-3.549761 -47.270466,-3.550104 -47.26978,-3.550327 -47.269419,-3.550532 -47.269059,-3.550686 -47.26875,-3.550892 -47.268372,-3.550772 -47.268149,-3.550515 -47.26863,-3.549898 -47.268887,-3.549419 -47.269282,-3.548939 -47.269419,-3.548665 -47.26966,-3.548476 -47.269831,-3.548391 -47.269934,-3.548425 -47.27002,-3.548322 -47.270157,-3.548099 -47.270278,-3.547894 -47.270415,-3.547654 -47.270415,-3.547483 -47.270432,-3.547243 -47.270398,-3.54702 -47.270415,-3.546866 -47.270586,-3.546866 -47.270758,-3.547089 -47.270878,-3.54726 -47.271067,-3.547431 -47.271119,-3.5475 -47.271222,-3.5475 -47.271393,-3.547534 -47.271513,-3.547534 -47.271719,-3.547688 -47.271943,-3.547842 -47.272097,-3.547928 -47.272372,-3.547997 -47.272612,-3.547911 -47.272767,-3.547791 -47.272955,-3.547688 -47.27299,-3.547568 -47.273024,-3.547345 -47.272904,-3.547208 -47.272698,-3.547191 -47.272543,-3.547191 -47.272217,-3.547071 -47.271908,-3.546643 -47.271479,-3.5463 -47.270964,-3.545769 -47.270758,-3.545684 -47.270655,-3.545632 -47.270655,-3.545427 -47.270689,-3.545272 -47.270501,-3.545135 -47.27038,-3.545033 -47.270398,-3.544604 -47.270346,-3.54433 -47.270243,-3.544056 -47.270346,-3.54385 -47.270329,-3.543679 -47.270209,-3.543473 -47.270003,-3.543216 -47.2699,-3.543045 -47.2699,-3.542857 -47.270003,-3.542788 -47.270003,-3.542634 -47.269883,-3.542565 -47.269866,-3.542394 -47.269917,-3.542223 -47.270003,-3.542051 -47.270175,-3.541966 -47.270312,-3.54128 -47.270415,-3.540886 -47.270621,-3.540561 -47.270775,-3.540338 -47.270964,-3.539858 -47.271119,-3.539516 -47.271204,-3.539241 -47.271033,-3.53907 -47.270724,-3.538727 -47.270707,-3.538488 -47.270466,-3.538179 -47.270192,-3.538008 -47.269917,-3.537785 -47.269608,-3.537579 -47.269299,-3.537477 -47.269042,-3.537357 -47.268956,-3.537254 -47.268921,-3.5371 -47.268921,-3.536843 -47.269059,-3.53662 -47.269213,-3.5365 -47.269471,-3.53614 -47.269745,-3.535952 -47.270089,-3.535866 -47.270278,-3.535712 -47.270483,-3.535506 -47.27081,-3.535506 -47.271119,-3.535541 -47.271256,-3.535386 -47.271393,-3.535266 -47.271513,-3.534992 -47.271479,-3.534752 -47.271359,-3.534513 -47.271153,-3.534393 -47.270947,-3.534324 -47.270758,-3.534273 -47.270552,-3.534221 -47.270466,-3.534221 -47.27026,-3.534187 -47.270209,-3.534136 -47.270106,-3.533964 -47.270054,-3.533742 -47.270037,-3.533553 -47.269969,-3.533348 -47.269917,-3.533039 -47.269848,-3.532799 -47.269728,-3.532577 -47.269728,-3.532457 -47.269951,-3.532388 -47.270226,-3.53232 -47.270535,-3.5322 -47.270878,-3.5322 -47.271119,-3.532045 -47.271359,-3.532045 -47.271496,-3.53196 -47.271582,-3.531686 -47.271685,-3.531429 -47.271822,-3.531292 -47.27196,-3.531052 -47.272149,-3.530932 -47.272303,-3.530846 -47.272492,-3.530709 -47.272629,-3.530726 -47.273282,-3.531703 -47.273694,-3.532422 -47.274088,-3.532971 -47.274329,-3.53333 -47.274518,-3.533502 -47.274655,-3.533742 -47.274861,-3.533981 -47.275015,-3.534204 -47.275239,-3.534633 -47.275239,-3.534838 -47.275256,-3.535027 -47.275376,-3.535215 -47.27553,-3.535301 -47.275582,-3.535489 -47.275565,-3.535763 -47.275565,-3.535969 -47.275668,-3.536209 -47.275685,-3.536346 -47.276028,-3.536466 -47.276303,-3.536586 -47.276286,-3.536757 -47.276371,-3.536963 -47.276492,-3.537271 -47.276715,-3.537528 -47.276955,-3.537648 -47.277247,-3.537768 -47.27759,-3.537768 -47.277762,-3.537648 -47.277968,-3.537494',
//   },
//   {
//     id: 3,
//     nome: 'TALHAO 2',
//     area: 300,
//     coordenadas:
//       '-47.294121,-3.540379 -47.294327,-3.540996 -47.294774,-3.542454 -47.294997,-3.543431 -47.29522,-3.544219 -47.29534,-3.544631 -47.295426,-3.544939 -47.295426,-3.545196 -47.293812,-3.545814 -47.291409,-3.546791 -47.287444,-3.548419 -47.284028,-3.549842 -47.280921,-3.551162 -47.279393,-3.551762 -47.277195,-3.552705 -47.273865,-3.554128 -47.273694,-3.554214 -47.272509,-3.553494 -47.271273,-3.552534 -47.270003,-3.551728 -47.268853,-3.550939 -47.268801,-3.550888 -47.273024,-3.549122 -47.275719,-3.548025 -47.278723,-3.546774 -47.280423,-3.546071 -47.281538,-3.545625 -47.282071,-3.545402 -47.2825,-3.545196 -47.285882,-3.543774 -47.287959,-3.542916 -47.290001,-3.542059 -47.290946,-3.541648 -47.291701,-3.541339 -47.29237,-3.541048 -47.293108,-3.540739 -47.293417,-3.540551 -47.294121,-3.540379',
//   },
// ];

const talhoes: talhao[] = [];

async function initMap(): Promise<void> {
  const initialCoordinates = { lat: -2.9912935, lng: -47.3536209 };

  map = new google.maps.Map(mapElement as HTMLElement, {
    center: initialCoordinates,
    zoom: 16,
    mapTypeId: 'satellite',
    disableDefaultUI: true,
    zoomControl: true,
  });
  infoWindow = new google.maps.InfoWindow();
  geocoder = new google.maps.Geocoder();

  if (talhoes.length === 0) {
    if (!cidade || !uf) {
      return;
    }

    const coordinates = await getCityCoordinates(geocoder, cidade, uf);
    map.setCenter(coordinates);
  } else {
    const allCoordinates: CoordinatesType[] = [];

    talhoes.forEach((talhao) => {
      const coordinatesArray: CoordinatesType[] =
        convertStringCoordinatesToArray(talhao.coordenadas);

      const talhaoPolygon = new google.maps.Polygon({
        map,
        paths: coordinatesArray,
        fillColor: idTalhao === talhao.id ? '#FF9A1F' : '#009056',
        fillOpacity: 0.7,
        strokeColor: idTalhao === talhao.id ? '#F7BC91' : '#AFF9C7',
        strokeWeight: 3,
        ...(idTalhao === talhao.id && { zIndex: 999 }),
      });

      talhaoPolygon.addListener('click', (event: any) => {
        const contentString = `
          <b class="talhao-name">${talhao.nome}</b><br />
          <b class="talhao-label">√Årea: </b>
          <span class="talhao-info">${talhao.area} ha</span><br />
        `;

        infoWindow.setContent(contentString);
        infoWindow.setOptions;
        infoWindow.setPosition(event.latLng);

        infoWindow.open(map);
      });

      talhaoPolygon.addListener('mouseout', () => {
        infoWindow.close();
      });

      allCoordinates.push(...coordinatesArray);
    });

    const { bounds, center } = getAreasCenter(allCoordinates);
    const zoomLevel = getZoomLevel(bounds, {
      height: map.getDiv().clientHeight,
      width: map.getDiv().clientWidth,
    });

    map.setCenter(center);
    map.setZoom(zoomLevel);
  }
}

declare global {
  interface Window {
    initMap: () => void;
  }
}
window.initMap = initMap;

export {};
